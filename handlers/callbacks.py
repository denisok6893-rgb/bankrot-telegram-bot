"""
CASE callbacks - Phase 8
Migrated from bot.py to modular handlers.
"""

# ============================================================================
# CASE CALLBACKS - PHASE 8 (5 callbacks)
# ============================================================================

# Lines 2738-2773 from bot.py
@dp.callback_query(lambda c: c.data.startswith("case:card:"))
async def case_card_open(call: CallbackQuery, state: FSMContext):
    uid = call.from_user.id
    if not is_allowed(uid):
        await call.answer()
        return

    cid = int(call.data.split(":")[2])
    await state.update_data(card_case_id=cid)
    card = get_case_card(uid, cid) or {}

    lines = [f"üìÅ –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–µ–ª–∞ #{cid}"]
    for key, title in [
        ("court_name", "–°—É–¥"),
        ("court_address", "–ê–¥—Ä–µ—Å —Å—É–¥–∞"),
        ("debtor_full_name", "–î–æ–ª–∂–Ω–∏–∫"),
        ("debtor_gender", "–ü–æ–ª"),
        ("debtor_birth_date", "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è"),
        ("debtor_address", "–ê–¥—Ä–µ—Å –¥–æ–ª–∂–Ω–∏–∫–∞"),
        ("passport_series", "–ü–∞—Å–ø–æ—Ä—Ç —Å–µ—Ä–∏—è"),
        ("passport_number", "–ü–∞—Å–ø–æ—Ä—Ç –Ω–æ–º–µ—Ä"),
        ("passport_issued_by", "–ö–µ–º –≤—ã–¥–∞–Ω –ø–∞—Å–ø–æ—Ä—Ç"),
        ("passport_date", "–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞"),
        ("passport_code", "–ö–æ–¥ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è"),
        ("total_debt_rubles", "–°—É–º–º–∞ –¥–æ–ª–≥–∞ (—Ä—É–±–ª–∏)"),
        ("total_debt_kopeks", "–°—É–º–º–∞ –¥–æ–ª–≥–∞ (–∫–æ–ø–µ–π–∫–∏)"),
    ]:
        lines.append(f"{title}: {card.get(key) or '‚Äî'}")

    kb = InlineKeyboardBuilder()
    kb.button(text="‚úèÔ∏è –ó–∞–ø–æ–ª–Ω–∏—Ç—å", callback_data=f"card:fill:{cid}")
    kb.button(text="üîô –ù–∞–∑–∞–¥", callback_data=f"case:open:{cid}")
    kb.adjust(1)

    await call.message.answer("\n".join(lines), reply_markup=kb.as_markup())
    await call.answer()


# Lines 3050-3085 from bot.py
@dp.callback_query(lambda c: c.data.startswith("case:card_edit:"))
async def case_card_edit(call: CallbackQuery, state: FSMContext):
    uid = call.from_user.id
    if not is_allowed(uid):
        await call.answer()
        return

    _, _, cid_str, field = call.data.split(":", maxsplit=3)
    cid = int(cid_str)

    if field not in CASE_CARD_FIELD_META:
        await call.answer()
        return

    row = get_case(uid, cid)
    if not row:
        await call.message.answer("–î–µ–ª–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        await call.answer()
        return

    # ‚úÖ –í–ê–ñ–ù–û: creditors ‚Äî —ç—Ç–æ –ù–ï —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ, –∞ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –º–µ–Ω—é
    if field == "creditors":
        await state.clear()
        await state.update_data(card_case_id=cid)
        await send_creditors_menu(call.message, uid, cid)
        await call.answer()
        return

    await state.clear()
    await state.update_data(card_cid=cid, card_field=field)
    await state.set_state(CaseCardFill.waiting_value)

    prompt = CASE_CARD_FIELD_META[field]["prompt"] + "\n–û—Ç–ø—Ä–∞–≤—å '-' —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º."
    await call.message.answer(prompt)
    await call.answer()


# Lines 3127-3155 from bot.py
@dp.callback_query(lambda c: c.data.startswith("case:cardfield:"))
async def card_field_start(call: CallbackQuery, state: FSMContext):
    uid = call.from_user.id
    if not is_allowed(uid):
        await call.answer()
        return

    _, _, cid_str, field = call.data.split(":", maxsplit=3)
    cid = int(cid_str)

    if field not in CASE_CARD_FIELD_META:
        await call.answer()
        return

    # –ö—Ä–µ–¥–∏—Ç–æ—Ä—ã ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ –º–µ–Ω—é, –Ω–µ –æ–±—ã—á–Ω—ã–π –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
    if field == "creditors":
        await state.clear()
        await state.update_data(card_case_id=cid)
        await send_creditors_menu(call.message, uid, cid)
        await call.answer()
        return

    await state.clear()
    await state.update_data(card_case_id=cid, card_field_key=field)
    await state.set_state(CaseCardFill.waiting_value)

    prompt = CASE_CARD_FIELD_META[field]["prompt"] + "\n–û—Ç–ø—Ä–∞–≤—å '-' —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º."
    await call.message.answer(prompt)
    await call.answer()


# Lines 3312-3324 from bot.py
@dp.callback_query(lambda c: c.data.startswith("case:creditors:"))
async def creditors_menu(call: CallbackQuery, state: FSMContext):
    uid = call.from_user.id
    if not is_allowed(uid):
        await call.answer()
        return

    cid = int(call.data.split(":")[2])
    await state.clear()
    await state.update_data(card_case_id=cid)

    await send_creditors_menu(call.message, uid, cid)
    await call.answer()


# Lines 3591-3631 from bot.py
@dp.callback_query(lambda c: c.data.startswith("case:edit:") and c.data.count(":") == 3)
async def case_edit_start(call: CallbackQuery, state: FSMContext):
    uid = call.from_user.id
    if not is_allowed(uid):
        await call.answer()
        return

    _, _, cid_str, field = call.data.split(":")
    cid = int(cid_str)

    # –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –¥–µ–ª–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ç–≤–æ—ë
    row = get_case(uid, cid)
    if not row:
        await call.message.answer("–î–µ–ª–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        await call.answer()
        return

    await state.clear()
    await state.update_data(edit_cid=cid, edit_field=field)
    await state.set_state(CaseEdit.value)

    field_titles = {
        "case_number": "–Ω–æ–º–µ—Ä –¥–µ–ª–∞",
        "court": "—Å—É–¥",
        "judge": "—Å—É–¥—å—é",
        "fin_manager": "—Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ",
        "stage": "—Å—Ç–∞–¥–∏—é",
        "notes": "–∑–∞–º–µ—Ç–∫–∏",
    }
    title = field_titles.get(field, field)

    kb = InlineKeyboardBuilder()
    kb.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"case:edit:{cid}")
    kb.adjust(1)

    await call.message.answer(
        f"–í–≤–µ–¥–∏ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ¬´{title}¬ª.\n–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ ‚Äî –æ—Ç–ø—Ä–∞–≤—å `-`.",
        reply_markup=kb.as_markup(),
    )

    await call.answer()


# Lines 3632-3682 from bot.py (FSM handler for case_edit_start)
@dp.message(CaseEdit.value)
async def case_edit_apply(message: Message, state: FSMContext):
    uid = message.from_user.id
    if not is_allowed(uid):
        return

    data = await state.get_data()
    cid = data.get("edit_cid")
    field = data.get("edit_field")

    if not cid or not field:
        await state.clear()
        await message.answer("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ù–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç–æ—á–∫—É –¥–µ–ª–∞.")
        return

    text = (message.text or "").strip()
    if not text:
        await message.answer("–ü—É—Å—Ç–æ. –í–≤–µ–¥–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ '-' —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å.")
        return

    value = None if text == "-" else text

    if field in ("case_number", "court", "judge", "fin_manager"):
        update_case_fields(
            uid,
            cid,
            case_number=value if field == "case_number" else None,
            court=value if field == "court" else None,
            judge=value if field == "judge" else None,
            fin_manager=value if field == "fin_manager" else None,
        )
    elif field in ("stage", "notes"):
        update_case_meta(
            uid,
            cid,
            stage=value if field == "stage" else None,
            notes=value if field == "notes" else None,
        )
    else:
        await message.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.")
        await state.clear()
        return
    await state.clear()

    # –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî –≤–µ—Ä–Ω—É—Ç—å –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
    fake = type("X", (), {})()
    fake.from_user = message.from_user
    fake.data = f"case:edit:{cid}"
    fake.message = message
    await case_edit_menu(fake, state)
